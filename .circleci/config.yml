version: 2.1

parameters:
  cli-version:
    type: string
    default: "0.1.30549"
  staging-hostname:
    type: string
    default: "https://server.rc.sphereci.com"

executors:
  cli-docker:
    docker:
      - image: circleci/circleci-cli:<< pipeline.parameters.cli-version >>
    environment:
      CIRCLE_HOSTNAME: << pipeline.parameters.staging-hostname >>
      GITHUB_API_HOSTNAME: "https://api.github.com"
    resource_class: xlarge

commands:            
  staging-setup:
    parameters:
      circle-hostname:
        type: string
    steps:
      - run:
          name: Fetch GraphQL details
          command: |
              curl "https://$CIRCLE_HOSTNAME/graphql-unstable" -H 'Connection: keep-alive' \
              -H "Circle-Token: $CIRCLE_TOKEN" \
              -H 'Content-Type: application/json' \
              --data-binary '{"query":"{\n\torganization(name:\"vijaypandian\",vcsType:GITHUB){\n    plan{\n      metrics(dateRange:{start:\"2025-07-01\",end:\"2025-07-31\"}) {\n        byProject{\n          nodes{\n            project{\n              name\n              organization{\n                name\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}","variables":null}' 
      - run:
          name: Setup CircleCI Orb
          command: circleci setup --host "$CIRCLE_HOSTNAME" --token "$CIRCLE_TOKEN" --skip-update-check --no-prompt
      - run:
          name: Fetch Orgs available to the CircleCI Token 
          command: circleci info org --host "$CIRCLE_HOSTNAME" --token "$CIRCLE_TOKEN"
      - run: 
          name: Import orbs
          command: |
              bash import-orbs.sh
    
jobs:
  import-orbs:
    executor: cli-docker
    parameters:
      circle-hostname:
        type: string
    steps:
      - checkout
      - staging-setup:
          circle-hostname: << pipeline.parameters.staging-hostname >>


workflows:
  stage:
    jobs:
      - import-orbs:
           circle-hostname: << pipeline.parameters.staging-hostname >>
           name: "staging-env-import"
           context: "server-rc-context"
           filters: pipeline.git.branch == "rc-test"
